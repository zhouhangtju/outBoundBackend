外呼中间层

## 1.功能介绍

负责接收性能中心上传的电话号码，处理后调用外呼系统进行外呼。接收外呼系统的回调数据，处理后上传给性能中心。

接收电话号码信息时将质差派单号码存入redis，确保今天只调用一次。

## 2.主要接口和项目结构说明

```
1.接收电话号码信息，并调用外呼系统
http://localhost:8091/openapi/performanceInfo
2. 接收外呼系统回调信息，处理后上传性能中心
http://localhost:8091/callback/newInsertData
```

项目结构

```
src
└── main
    ├── java
    │   └── com.mobile.smartcalling
    │       ├── common               # 公共工具/枚举
    │       │   ├── ChineseAffirmativeChecker # 中文句校验工具(未使用)
    │       │   ├── CommonResult/CommonResultEnum # 统一返回结果及状态枚举
    │       │   ├── NodeName         # 节点名称定义类
    │       │   ├── TaskUUIDEnum     # 外呼任务ID枚举类
    │       │   └── TimeConverter    # 时间转换工具类(未使用)
    │       ├── config               # 配置类
    │       ├── controller           # 控制层（接口入口）
    │       │   ├── CallBackController # 接收外呼系统回调数据的接口
    │       │   ├── DemoController   # 示例接口控制器
    │       │   └── OpenApiController # 接收性能侧电话号码的接口
    │       ├── dao                  # 数据访问层，连接数据库
    │       ├── dto                  # 数据传输对象，实体类
    │       ├── entity               # 实体类
    │       ├── service              # 业务逻辑层
    │       │   ├── impl             # 业务接口实现类
    │       │   │   ├── CallbackServiceimpl # 回调数据解析业务实现
    │       │   │   ├── ReadCSVServiceimpl # CSV文件读取业务实现(未使用)
    │       │   │   ├── UploadCSVServiceimpl # CSV文件上传业务实现(未使用)
    │       │   │   └── UploadDataServiceimpl # 性能侧电话号码上传外呼系统实现
    │       │   └── IXXXService      # 业务接口，对应实现类
    │       ├── util                 # 工具类
    │       └── SmartcallingApplication # 项目启动类
    └── resources
        ├── application.yml            # Spring Boot 主配置文件，包含全局配置（端口、数据库连接等）
        ├── application-dev.yml        # 开发环境配置文件
        ├── application-prod.yml       # 生产环境配置文件
        ├── application-test.yml       # 测试环境配置文件
        └── logback.xml                # Logback 日志框架配置文件，定义日志输出格式、路径、级别等
```

核心代码  位于CallbackServiceimpl  ，该方法根据任务名称关键字匹配不同的业务场景，分别处理 “存量维系”、“装机单竣工回访”、“投诉单报结”、“质差修复已上门”、“质差派单” 等任务，生成对应结果并入库或上传。

```
    @Override
    public void getNewJsonData(NewCallbackData newCallbackData) {
        try {
            if(newCallbackData.getData()!=null&&newCallbackData.getData().size()!=0){
                List<NewCallbackData.CallRecordData> data = newCallbackData.getData();
                for (int i = 0; i < data.size(); i++) {
                    NewCallbackData.CallRecordData callRecordData = data.get(i);
                    NewCallbackData.Task task = callRecordData.getTask();
                    if(task.getName().contains("存量维系")){
                        //   ResultDB resultDB = new ResultDB();
                        ResultDB resultDB = newStockMaintenanceType(callRecordData);
                        log.info("存量维系回调信息入库结果{}", resultDB);
                        resultDBDao.insert(resultDB);
                    }
                    if(task.getName().contains("装机单竣工回访")){
                        //RemoteCallResultDto resultDto = checkInstallationCompletion(callbackData);
                        RemoteCallResultDto resultDto = newCheckInstallationCompletion(callRecordData);
                        resultDto.setOrderid(callRecordData.getCustomer_data().getExtra());
                        log.info("装机单竣工回访场景结果{}",resultDto);
                        uploadDataService.uploadResult(resultDto,task.getName());
                    }
                    if(task.getName().contains("投诉单报结")){
                        //RemoteCallResultDto resultDto = followUpResolvedComplaints(callbackData);
                        RemoteCallResultDto resultDto = newFollowUpResolvedComplaints(callRecordData);
                        resultDto.setOrderid(callRecordData.getCustomer_data().getExtra());
                        log.info("投诉单报结回访场景结果{}",resultDto);
                        uploadDataService.uploadResult(resultDto,task.getName());
                    }
                    if(task.getName().contains("质差修复已上门")){
                        // RemoteCallResultDto resultDto = sendPoorQualitySurvey(callbackData);
                        RemoteCallResultDto resultDto = newSendPoorQualitySurvey(callRecordData);
                        resultDto.setOrderid(callRecordData.getCustomer_data().getExtra());
                        log.info("质差修复已上门场景结果{}",resultDto);
                        uploadDataService.uploadResult(resultDto,task.getName());
                    }
                    if(task.getName().contains("质差派单")){
                        //RemoteCallResultDto resultDto = createPoorQualityDispatchSurvey(callbackData);
                        PoorQualityResultRequest resultDto = newCreatePoorQualityDispatchSurvey(callRecordData);
                        // resultDto.setOrderid(order);
                        log.info("质差派单场景结果{}",resultDto);
                        uploadDataService.uploadPoorQualityResult(resultDto);
                    }
                }
            }else {
                log.info("回调数据为空");
            }
        }catch (Exception e){
            log.info("{}",e);
        }

    }
```



## 3.数据库信息

```
存储手机号和任务id，用来区分是否拨打过。
CREATE TABLE `task_phone` (
  `phone` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `task_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

存量维系结果数据表
CREATE TABLE `satisfy_result`  (
  `phone_num` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '手机号',
  `customer_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '名字',
  `internet_quality_score` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '上网质量满意度打分',
  `install_score` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '安装维修满意度打分',
  `reason` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '不满意原因',
  `is_home` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '是否需要上门',
  `start_time` datetime NULL DEFAULT NULL COMMENT '外呼时间',
  `is_contact` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '是否联系成功',
  `ds` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL COMMENT '分区日期'
) ENGINE = InnoDB;

```



## 4.服务器配置信息

```
188.107.245.55

jar包部署路径
/usr/local/newremotecall/

docker部署mysql 8.0.31
密码root
docker exec -it 0172d9278e6e /bin/bash

docker run -d \
-p 3306:3306 \
-v /data1/mysql/docker-mysql/data:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=root \
--name mysql \
--restart=always \
mysql:8.0.31

redis 6.2.19
docker run -d -p 6379:6379 --name redis --restart=always redis:6.2.19 --requirepass "QWER1234"



java环境 jdk8
路径: /usr/local/remotecall/jdk1.8.0_221

```

